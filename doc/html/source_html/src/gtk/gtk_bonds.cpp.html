<!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><i><font color="#9A1900">/* optionmatrix:                                                            */</font></i>
<i><font color="#9A1900">/*                                                                          */</font></i>
<i><font color="#9A1900">/* Options &amp; Futures Matrix Modeler                                         */</font></i>
<i><font color="#9A1900">/* View and Control Theoretical Option Chains                               */</font></i>
<i><font color="#9A1900">/*                                                                          */</font></i>
<i><font color="#9A1900">/* File: gtk_bonds.cpp of optionmatrix                                      */</font></i>
<i><font color="#9A1900">/*                                                                          */</font></i>
<i><font color="#9A1900">/* Copyright (c) Anthony Bradford. 2012.                                    */</font></i>
<i><font color="#9A1900">/* </font></i><u><font color="#0000FF">http://anthonybradford.com</font></u><i><font color="#9A1900">                                               */</font></i>
<i><font color="#9A1900">/* </font></i><u><font color="#0000FF">info@anthonybradford.com</font></u><i><font color="#9A1900">                                                 */</font></i>
<i><font color="#9A1900">/*                                                                          */</font></i>
<i><font color="#9A1900">/* optionmatrix may be freely redistributed.                                */</font></i>
<i><font color="#9A1900">/* See file COPYING included with this distribution for license information */</font></i>

<i><font color="#9A1900">/* </font></i>
<i><font color="#9A1900">   optionmatrix program is free software; you can redistribute it and/or modify</font></i>
<i><font color="#9A1900">   it under the terms of the GNU General Public License as published by</font></i>
<i><font color="#9A1900">   the Free Software Foundation; either version 3 of the License, or</font></i>
<i><font color="#9A1900">   (at your option) any later version.</font></i>

<i><font color="#9A1900">   optionmatrix program is distributed in the hope that it will be useful,</font></i>
<i><font color="#9A1900">   but WITHOUT ANY WARRANTY; without even the implied warranty of</font></i>
<i><font color="#9A1900">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</font></i>
<i><font color="#9A1900">   GNU General Public License for more details.</font></i>

<i><font color="#9A1900">   You should have received a copy of the GNU General Public License</font></i>
<i><font color="#9A1900">   along with this program.  If not, see </font></i><u><font color="#0000FF">&lt;http://www.gnu.org/licenses/&gt;</font></u><i><font color="#9A1900">.</font></i>
<i><font color="#9A1900">*/</font></i>

<b><font color="#000080">#include</font></b> <font color="#FF0000">"../common/defs.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"../common/extern.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"gtk_extern.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"../common/prototypes.h"</font>

<b><font color="#0000FF">struct</font></b> <font color="#008080">_data</font> <b><font color="#000000">bonddispatch</font></b><font color="#990000">(</font><b><font color="#0000FF">struct</font></b> <font color="#008080">_properties</font> <font color="#990000">*</font>p<font color="#990000">)</font>
<font color="#FF0000">{</font>
  <b><font color="#0000FF">struct</font></b> <font color="#008080">_data</font> <font color="#990000">*</font>dat<font color="#990000">;</font>
  dat <font color="#990000">=</font> <font color="#990000">(</font><b><font color="#0000FF">struct</font></b> <font color="#008080">_data</font> <font color="#990000">*)</font> <font color="#990000">&amp;</font>p<font color="#990000">-&gt;</font>data<font color="#990000">;</font>
  <b><font color="#0000FF">const</font></b> <font color="#009900">double</font> rate <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>rate<font color="#990000">;</font>

  <i><font color="#9A1900">// t3 only used by case EURBOND_HO_LEE which</font></i>
  <i><font color="#9A1900">// is commented out pending the fixing of a Segmentation fault...</font></i>
  <i><font color="#9A1900">//const double t3 = dat-&gt;t[2] - dat-&gt;te3;</font></i>

  <i><font color="#9A1900">//g_print("rate = %f\n", rate);</font></i>

  dat<font color="#990000">-&gt;</font>bond_price <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
  dat<font color="#990000">-&gt;</font>pv_discrete <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
  dat<font color="#990000">-&gt;</font>pv_continous <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
  dat<font color="#990000">-&gt;</font>irr_discrete <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
  dat<font color="#990000">-&gt;</font>irr <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
  dat<font color="#990000">-&gt;</font>uirr <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
  dat<font color="#990000">-&gt;</font>YTMDiscrete <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
  dat<font color="#990000">-&gt;</font>YTMContinous <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
  dat<font color="#990000">-&gt;</font>durationDiscrete <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
  dat<font color="#990000">-&gt;</font>durationContinous <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
  dat<font color="#990000">-&gt;</font>durationMacaulayDiscrete <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
  dat<font color="#990000">-&gt;</font>durationModifiedDiscrete <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
  dat<font color="#990000">-&gt;</font>convexityDiscrete <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
  dat<font color="#990000">-&gt;</font>convexityContinous <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
  dat<font color="#990000">-&gt;</font>call <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>

  <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>

  <b><font color="#0000FF">switch</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>modeltype<font color="#990000">)</font>
  <font color="#FF0000">{</font>

<b><font color="#000080">#ifdef</font></b> FINRECIPES

  <b><font color="#0000FF">case</font></b> BONDS<font color="#990000">:</font>
    <font color="#FF0000">{</font>

    <i><font color="#9A1900">//g_print("BOND Flat term\n");</font></i>

    <b><font color="#000000">pthread_mutex_lock</font></b><font color="#990000">(&amp;</font>dat<font color="#990000">-&gt;</font>mutexCashflow<font color="#990000">);</font>

    <b><font color="#0000FF">static</font></b> <font color="#009900">int</font> numberOfCoupons <font color="#990000">=</font> <font color="#993399">5</font><font color="#990000">;</font>
    <font color="#009900">int</font> numberOfCouponsSelected <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>UseS<font color="#990000">;</font>

    <b><font color="#0000FF">static</font></b> <font color="#009900">double</font> couponValue <font color="#990000">=</font> <font color="#993399">1.25</font><font color="#990000">;</font>
    <font color="#009900">double</font> couponValueSelected <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>UseT<font color="#990000">;</font>

    <b><font color="#0000FF">static</font></b> <font color="#009900">int</font> periodicity <font color="#990000">=</font> <font color="#993399">2</font><font color="#990000">;</font>
    <font color="#009900">int</font> periodicitySelected <font color="#990000">=</font> <font color="#990000">(</font><font color="#009900">int</font><font color="#990000">)</font> dat<font color="#990000">-&gt;</font>UseQ<font color="#990000">;</font>

    <b><font color="#0000FF">static</font></b> <font color="#009900">double</font> firstCoupon <font color="#990000">=</font> <font color="#990000">.</font><font color="#993399">25</font><font color="#990000">;</font>
    <font color="#009900">double</font> firstCouponSelected <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>UseR<font color="#990000">;</font>

    <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"firstCoupon = %f, firstCouponSelected = %f</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> firstCoupon<font color="#990000">,</font> firstCouponSelected<font color="#990000">);</font>
    <i><font color="#9A1900">//g_print("dat-&gt;coupon.size() = %d\n", dat-&gt;coupon.size() );</font></i>

    <b><font color="#0000FF">if</font></b><font color="#990000">(</font> numberOfCoupons <font color="#990000">!=</font> numberOfCouponsSelected <font color="#990000">||</font> couponValue <font color="#990000">!=</font> couponValueSelected <font color="#990000">||</font>
        periodicity <font color="#990000">!=</font> periodicitySelected <font color="#990000">||</font> firstCoupon <font color="#990000">!=</font> firstCouponSelected <font color="#990000">)</font>
    <font color="#FF0000">{</font>
      numberOfCoupons <font color="#990000">=</font> numberOfCouponsSelected<font color="#990000">;</font>
      couponValue <font color="#990000">=</font> couponValueSelected<font color="#990000">;</font>
      periodicity <font color="#990000">=</font> periodicitySelected<font color="#990000">;</font>
      firstCoupon <font color="#990000">=</font> firstCouponSelected<font color="#990000">;</font>

      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"Number of Coupons Changed: %d</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> numberOfCoupons<font color="#990000">);</font>

      dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">erase</font></b><font color="#990000">(</font> dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">(),</font> dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">()</font> <font color="#990000">);</font>
      dat<font color="#990000">-&gt;</font>coupon_times<font color="#990000">.</font><b><font color="#000000">erase</font></b><font color="#990000">(</font> dat<font color="#990000">-&gt;</font>coupon_times<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">(),</font> dat<font color="#990000">-&gt;</font>coupon_times<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">()</font> <font color="#990000">);</font>

      <font color="#009900">int</font> counter<font color="#990000">;</font>
      <b><font color="#0000FF">for</font></b><font color="#990000">(</font>counter <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> counter <font color="#990000">&lt;</font> numberOfCoupons<font color="#990000">;</font> counter<font color="#990000">++)</font>
      <font color="#FF0000">{</font>
        dat<font color="#990000">-&gt;</font>coupon_times<font color="#990000">.</font><b><font color="#000000">push_back</font></b><font color="#990000">(</font>firstCoupon<font color="#990000">);</font>

        <b><font color="#0000FF">if</font></b><font color="#990000">(</font> counter <font color="#990000">==</font> <font color="#990000">(</font>numberOfCoupons <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">)</font> <font color="#990000">)</font>
            dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">push_back</font></b><font color="#990000">(</font><font color="#993399">100</font> <font color="#990000">+</font> dat<font color="#990000">-&gt;</font>UseT<font color="#990000">);</font> 
        <b><font color="#0000FF">else</font></b>
          dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">push_back</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>UseT<font color="#990000">);</font> 
        
        <b><font color="#0000FF">if</font></b><font color="#990000">(</font> periodicity <font color="#990000">)</font>
          firstCoupon <font color="#990000">+=</font>  <font color="#990000">(</font><font color="#009900">double</font><font color="#990000">)</font> <font color="#993399">1</font> <font color="#990000">/</font> periodicity<font color="#990000">;</font>
      <font color="#FF0000">}</font>

    <font color="#FF0000">}</font>

    <b><font color="#0000FF">if</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>debug<font color="#990000">)</font>
    <font color="#FF0000">{</font>
      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"coupons = "</font><font color="#990000">);</font>
      
      <b><font color="#0000FF">for</font></b><font color="#990000">(</font> std<font color="#990000">::</font>vector<font color="#990000">&lt;</font><font color="#009900">double</font><font color="#990000">&gt;::</font><font color="#008080">iterator</font> it <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">();</font> it <font color="#990000">!=</font> dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">();</font> <font color="#990000">++</font>it<font color="#990000">)</font>
      <font color="#FF0000">{</font>
        <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"%lf "</font><font color="#990000">,</font> <font color="#990000">*</font>it<font color="#990000">);</font>
      <font color="#FF0000">}</font>

      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">times = "</font><font color="#990000">);</font>

      <b><font color="#0000FF">for</font></b><font color="#990000">(</font> std<font color="#990000">::</font>vector<font color="#990000">&lt;</font><font color="#009900">double</font><font color="#990000">&gt;::</font><font color="#008080">iterator</font> it <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">();</font> it <font color="#990000">!=</font> dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">();</font> <font color="#990000">++</font>it<font color="#990000">)</font>
      <font color="#FF0000">{</font>
        <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"%lf "</font><font color="#990000">,</font> <font color="#990000">*</font>it<font color="#990000">);</font>
      <font color="#FF0000">}</font>

      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>

    <i><font color="#9A1900">// cash_flow_pv_discrete() and bonds_price_discrete() should produce the</font></i>
    <i><font color="#9A1900">// same result...</font></i>
    dat<font color="#990000">-&gt;</font>pv_discrete <font color="#990000">=</font> <b><font color="#000000">cash_flow_pv_discrete</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>rate<font color="#990000">);</font>
    <font color="#009900">double</font> pv_discrete2 <font color="#990000">=</font> <b><font color="#000000">bonds_price_discrete</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>rate<font color="#990000">);</font>
    <font color="#009900">double</font> epsilon <font color="#990000">=</font> <font color="#993399">0.00001</font><font color="#990000">;</font>

    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <b><font color="#000000">fabs</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>pv_discrete <font color="#990000">-</font> pv_discrete2<font color="#990000">)</font> <font color="#990000">&gt;</font> epsilon <font color="#990000">)</font>
      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"ERROR: Mismatch dat-&gt;pv_discrete( %f ) != pv_discrete2 ( %f )</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> dat<font color="#990000">-&gt;</font>pv_discrete<font color="#990000">,</font>pv_discrete2<font color="#990000">);</font>

    <i><font color="#9A1900">// cash_flow_pv() and bonds_price() should produce the</font></i>
    <i><font color="#9A1900">// same result..</font></i>
    dat<font color="#990000">-&gt;</font>pv_continous <font color="#990000">=</font> <b><font color="#000000">cash_flow_pv</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>rate<font color="#990000">);</font>
    <font color="#009900">double</font> pv_continous2 <font color="#990000">=</font> <b><font color="#000000">bonds_price</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>rate<font color="#990000">);</font>

    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <b><font color="#000000">fabs</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>pv_continous <font color="#990000">-</font> pv_continous2<font color="#990000">)</font> <font color="#990000">&gt;</font> epsilon <font color="#990000">)</font>
      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"ERROR: Mismatch dat-&gt;pv_continous( %f ) != pv_continous2 ( %f )</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> dat<font color="#990000">-&gt;</font>pv_continous<font color="#990000">,</font>pv_continous2<font color="#990000">);</font>

    <i><font color="#9A1900">//</font></i>

    dat<font color="#990000">-&gt;</font>YTMDiscrete <font color="#990000">=</font> <b><font color="#000000">bonds_yield_to_maturity_discrete</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>pv_discrete<font color="#990000">);</font>
    dat<font color="#990000">-&gt;</font>YTMContinous <font color="#990000">=</font> <b><font color="#000000">bonds_yield_to_maturity</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>pv_continous<font color="#990000">);</font>
    dat<font color="#990000">-&gt;</font>durationContinous <font color="#990000">=</font> <b><font color="#000000">bonds_duration</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>rate<font color="#990000">);</font>
    dat<font color="#990000">-&gt;</font>durationDiscrete <font color="#990000">=</font> <b><font color="#000000">bonds_duration_discrete</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>rate<font color="#990000">);</font>
    dat<font color="#990000">-&gt;</font>durationMacaulayDiscrete <font color="#990000">=</font> <b><font color="#000000">bonds_duration_macaulay_discrete</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>pv_discrete<font color="#990000">);</font>
    dat<font color="#990000">-&gt;</font>durationModifiedDiscrete <font color="#990000">=</font> <b><font color="#000000">bonds_duration_modified_discrete</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>pv_discrete<font color="#990000">);</font>
    dat<font color="#990000">-&gt;</font>convexityContinous <font color="#990000">=</font> <b><font color="#000000">bonds_convexity</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>rate<font color="#990000">);</font>
    dat<font color="#990000">-&gt;</font>convexityDiscrete <font color="#990000">=</font> <b><font color="#000000">bonds_convexity_discrete</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>rate<font color="#990000">);</font>

    <b><font color="#000000">pthread_mutex_unlock</font></b><font color="#990000">(&amp;</font>dat<font color="#990000">-&gt;</font>mutexCashflow<font color="#990000">);</font>

    <font color="#FF0000">}</font>

    <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

  <b><font color="#0000FF">case</font></b> BONDSTERM<font color="#990000">:</font>
    <font color="#FF0000">{</font>

    <i><font color="#9A1900">//g_print("term structure selected: %s\n", &amp;option_algorithms[BONDSTERM].StateNames[dat-&gt;UsePound-1].string[0]);</font></i>
    <i><font color="#9A1900">//g_print("term model number      : %d\n", term_structure_list[dat-&gt;UsePound-1].modeltype);</font></i>

    <i><font color="#9A1900">// I would like to give BONDSTERM control over numberOfCoupons, couponValue, periodicity and</font></i>
    <i><font color="#9A1900">// firstCoupon but I'm out of internal values to support this...</font></i>

    <b><font color="#0000FF">static</font></b> <font color="#009900">int</font> term_struct_bondsterm <font color="#990000">=</font> <font color="#990000">-</font><font color="#993399">1</font><font color="#990000">;</font>
    <font color="#009900">int</font> term_selected <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>UsePound<font color="#990000">-</font><font color="#993399">1</font><font color="#990000">;</font>

    <b><font color="#0000FF">if</font></b><font color="#990000">(</font> term_selected <font color="#990000">!=</font> term_struct_bondsterm <font color="#990000">)</font>
    <font color="#FF0000">{</font>
      term_struct_bondsterm <font color="#990000">=</font> term_selected<font color="#990000">;</font>
      <i><font color="#9A1900">//g_print("BONDSTERM: term struct changed\n");</font></i>

      <b><font color="#000000">on_comboboxModel_changed_hide</font></b><font color="#990000">(</font>term_structure_list<font color="#990000">[</font>dat<font color="#990000">-&gt;</font>UsePound<font color="#990000">-</font><font color="#993399">1</font><font color="#990000">].</font>modeltype<font color="#990000">,</font>p<font color="#990000">);</font>
      <b><font color="#000000">on_comboboxModel_changed_show</font></b><font color="#990000">(</font>term_structure_list<font color="#990000">[</font>dat<font color="#990000">-&gt;</font>UsePound<font color="#990000">-</font><font color="#993399">1</font><font color="#990000">].</font>modeltype<font color="#990000">,</font>p<font color="#990000">);</font>
      <b><font color="#000000">updateTime</font></b><font color="#990000">(</font>term_structure_list<font color="#990000">[</font>dat<font color="#990000">-&gt;</font>UsePound<font color="#990000">-</font><font color="#993399">1</font><font color="#990000">].</font>modeltype<font color="#990000">,</font>p<font color="#990000">);</font>
      <b><font color="#000000">updateVolatility</font></b><font color="#990000">(</font>term_structure_list<font color="#990000">[</font>dat<font color="#990000">-&gt;</font>UsePound<font color="#990000">-</font><font color="#993399">1</font><font color="#990000">].</font>modeltype<font color="#990000">,</font>p<font color="#990000">);</font>
    <font color="#FF0000">}</font>

    <b><font color="#0000FF">struct</font></b> <font color="#008080">_data</font> termstructuredata<font color="#990000">;</font>
    p<font color="#990000">-&gt;</font>data<font color="#990000">.</font>term_model <font color="#990000">=</font> term_structure_list<font color="#990000">[</font>dat<font color="#990000">-&gt;</font>UsePound<font color="#990000">-</font><font color="#993399">1</font><font color="#990000">].</font>modeltype<font color="#990000">;</font>
    termstructuredata <font color="#990000">=</font> <b><font color="#000000">termstructure</font></b><font color="#990000">(&amp;</font>p<font color="#990000">-&gt;</font>data<font color="#990000">);</font>

    <b><font color="#000000">pthread_mutex_lock</font></b><font color="#990000">(&amp;</font>dat<font color="#990000">-&gt;</font>mutexCashflow<font color="#990000">);</font>

    <b><font color="#0000FF">if</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>debug<font color="#990000">)</font>
    <font color="#FF0000">{</font>
      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"coupons = "</font><font color="#990000">);</font>
      
      <b><font color="#0000FF">for</font></b><font color="#990000">(</font> std<font color="#990000">::</font>vector<font color="#990000">&lt;</font><font color="#009900">double</font><font color="#990000">&gt;::</font><font color="#008080">iterator</font> it <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">();</font> it <font color="#990000">!=</font> dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">();</font> <font color="#990000">++</font>it<font color="#990000">)</font>
      <font color="#FF0000">{</font>
        <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"%lf "</font><font color="#990000">,</font> <font color="#990000">*</font>it<font color="#990000">);</font>
      <font color="#FF0000">}</font>

      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">times = "</font><font color="#990000">);</font>

      <b><font color="#0000FF">for</font></b><font color="#990000">(</font> std<font color="#990000">::</font>vector<font color="#990000">&lt;</font><font color="#009900">double</font><font color="#990000">&gt;::</font><font color="#008080">iterator</font> it <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">();</font> it <font color="#990000">!=</font> dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">();</font> <font color="#990000">++</font>it<font color="#990000">)</font>
      <font color="#FF0000">{</font>
        <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"%lf "</font><font color="#990000">,</font> <font color="#990000">*</font>it<font color="#990000">);</font>
      <font color="#FF0000">}</font>

      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>

    dat<font color="#990000">-&gt;</font>bond_price <font color="#990000">=</font> <b><font color="#000000">bonds_price</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,*</font>dat<font color="#990000">-&gt;</font>term<font color="#990000">);</font>
    dat<font color="#990000">-&gt;</font>durationContinous <font color="#990000">=</font> <b><font color="#000000">bonds_duration</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,*</font>dat<font color="#990000">-&gt;</font>term<font color="#990000">);</font>
    dat<font color="#990000">-&gt;</font>convexityContinous <font color="#990000">=</font> <b><font color="#000000">bonds_convexity</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,*</font>dat<font color="#990000">-&gt;</font>term<font color="#990000">);</font>

    <b><font color="#0000FF">delete</font></b> dat<font color="#990000">-&gt;</font>term<font color="#990000">;</font>

    <b><font color="#000000">pthread_mutex_unlock</font></b><font color="#990000">(&amp;</font>dat<font color="#990000">-&gt;</font>mutexCashflow<font color="#990000">);</font>

    <font color="#FF0000">}</font>

    <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

  <b><font color="#0000FF">case</font></b> BONDSPRINCIPAL<font color="#990000">:</font>
    <font color="#FF0000">{</font>

    <i><font color="#9A1900">//g_print("BOND w/ Principal Payments\n");</font></i>

    <b><font color="#000000">pthread_mutex_lock</font></b><font color="#990000">(&amp;</font>dat<font color="#990000">-&gt;</font>mutexCashflow<font color="#990000">);</font>

    <b><font color="#0000FF">static</font></b> <font color="#009900">int</font> numberOfCoupons <font color="#990000">=</font> <font color="#993399">5</font><font color="#990000">;</font>
    <font color="#009900">int</font> numberOfCouponsSelected <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>UseS<font color="#990000">;</font>

    <b><font color="#0000FF">static</font></b> <font color="#009900">double</font> couponValue <font color="#990000">=</font> <font color="#993399">1.25</font><font color="#990000">;</font>
    <font color="#009900">double</font> couponValueSelected <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>UseT<font color="#990000">;</font>

    <b><font color="#0000FF">static</font></b> <font color="#009900">int</font> periodicity <font color="#990000">=</font> <font color="#993399">2</font><font color="#990000">;</font>
    <font color="#009900">int</font> periodicitySelected <font color="#990000">=</font> <font color="#990000">(</font><font color="#009900">int</font><font color="#990000">)</font> dat<font color="#990000">-&gt;</font>UseQ<font color="#990000">;</font>

    <b><font color="#0000FF">static</font></b> <font color="#009900">double</font> firstCoupon <font color="#990000">=</font> <font color="#990000">.</font><font color="#993399">25</font><font color="#990000">;</font>
    <font color="#009900">double</font> firstCouponSelected <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>UseR<font color="#990000">;</font>

    <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"firstCoupon = %f, firstCouponSelected = %f</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> firstCoupon<font color="#990000">,</font> firstCouponSelected<font color="#990000">);</font>
    <i><font color="#9A1900">//g_print("dat-&gt;coupon.size() = %d\n", dat-&gt;coupon.size() );</font></i>

    <b><font color="#0000FF">if</font></b><font color="#990000">(</font> numberOfCoupons <font color="#990000">!=</font> numberOfCouponsSelected <font color="#990000">||</font> couponValue <font color="#990000">!=</font> couponValueSelected <font color="#990000">||</font>
        periodicity <font color="#990000">!=</font> periodicitySelected <font color="#990000">||</font> firstCoupon <font color="#990000">!=</font> firstCouponSelected <font color="#990000">)</font>
    <font color="#FF0000">{</font>
      numberOfCoupons <font color="#990000">=</font> numberOfCouponsSelected<font color="#990000">;</font>
      couponValue <font color="#990000">=</font> couponValueSelected<font color="#990000">;</font>
      periodicity <font color="#990000">=</font> periodicitySelected<font color="#990000">;</font>
      firstCoupon <font color="#990000">=</font> firstCouponSelected<font color="#990000">;</font>

      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"Number of Coupons Changed: %d</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> numberOfCoupons<font color="#990000">);</font>

      dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">erase</font></b><font color="#990000">(</font> dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">(),</font> dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">()</font> <font color="#990000">);</font>
      dat<font color="#990000">-&gt;</font>coupon_times<font color="#990000">.</font><b><font color="#000000">erase</font></b><font color="#990000">(</font> dat<font color="#990000">-&gt;</font>coupon_times<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">(),</font> dat<font color="#990000">-&gt;</font>coupon_times<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">()</font> <font color="#990000">);</font>

      <font color="#009900">int</font> counter<font color="#990000">;</font>
      <b><font color="#0000FF">for</font></b><font color="#990000">(</font>counter <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> counter <font color="#990000">&lt;</font> numberOfCoupons<font color="#990000">;</font> counter<font color="#990000">++)</font>
      <font color="#FF0000">{</font>
        dat<font color="#990000">-&gt;</font>coupon_times<font color="#990000">.</font><b><font color="#000000">push_back</font></b><font color="#990000">(</font>firstCoupon<font color="#990000">);</font>
        dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">push_back</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>UseT<font color="#990000">);</font> 
        
        <b><font color="#0000FF">if</font></b><font color="#990000">(</font> periodicity <font color="#990000">)</font>
          firstCoupon <font color="#990000">+=</font>  <font color="#990000">(</font><font color="#009900">double</font><font color="#990000">)</font> <font color="#993399">1</font> <font color="#990000">/</font> periodicity<font color="#990000">;</font>
      <font color="#FF0000">}</font>

    <font color="#FF0000">}</font>

    <i><font color="#9A1900">//</font></i>

    <b><font color="#0000FF">static</font></b> <font color="#009900">int</font> numberOfPrincipal <font color="#990000">=</font> <font color="#993399">5</font><font color="#990000">;</font>
    <font color="#009900">int</font> numberOfPrincipalSelected <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>UseJ<font color="#990000">;</font>

    <b><font color="#0000FF">static</font></b> <font color="#009900">double</font> principalValue <font color="#990000">=</font> <font color="#993399">20</font><font color="#990000">;</font>
    <font color="#009900">double</font> principalValueSelected <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>UseP<font color="#990000">;</font>

    <b><font color="#0000FF">static</font></b> <font color="#009900">int</font> pperiodicity <font color="#990000">=</font> <font color="#993399">2</font><font color="#990000">;</font>
    <font color="#009900">int</font> pperiodicitySelected <font color="#990000">=</font> <font color="#990000">(</font><font color="#009900">int</font><font color="#990000">)</font> dat<font color="#990000">-&gt;</font>UseZ<font color="#990000">;</font>

    <b><font color="#0000FF">static</font></b> <font color="#009900">double</font> firstPrincipal <font color="#990000">=</font> <font color="#990000">.</font><font color="#993399">25</font><font color="#990000">;</font>
    <font color="#009900">double</font> firstPrincipalSelected <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>UseB<font color="#990000">;</font>

    <i><font color="#9A1900">//g_print("pperiodicity = %d, dat-&gt;UseZ = %f\n", pperiodicity, dat-&gt;UseZ );</font></i>
    <i><font color="#9A1900">//g_print("dat-&gt;principal.size() = %d\n", dat-&gt;principal.size() );</font></i>

    <b><font color="#0000FF">if</font></b><font color="#990000">(</font> numberOfPrincipal <font color="#990000">!=</font> numberOfPrincipalSelected <font color="#990000">||</font> principalValue <font color="#990000">!=</font> principalValueSelected <font color="#990000">||</font>
        pperiodicity <font color="#990000">!=</font> pperiodicitySelected <font color="#990000">||</font>  firstPrincipal <font color="#990000">!=</font> firstPrincipalSelected <font color="#990000">)</font>
    <font color="#FF0000">{</font>
      numberOfPrincipal <font color="#990000">=</font> numberOfPrincipalSelected<font color="#990000">;</font>
      principalValue <font color="#990000">=</font> principalValueSelected<font color="#990000">;</font>
      pperiodicity <font color="#990000">=</font> pperiodicitySelected<font color="#990000">;</font>
      firstPrincipal <font color="#990000">=</font> firstPrincipalSelected<font color="#990000">;</font>

      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"Number of Principal Changed: %d</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> numberOfPrincipal<font color="#990000">);</font>

      dat<font color="#990000">-&gt;</font>principal<font color="#990000">.</font><b><font color="#000000">erase</font></b><font color="#990000">(</font> dat<font color="#990000">-&gt;</font>principal<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">(),</font> dat<font color="#990000">-&gt;</font>principal<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">()</font> <font color="#990000">);</font>
      dat<font color="#990000">-&gt;</font>principal_times<font color="#990000">.</font><b><font color="#000000">erase</font></b><font color="#990000">(</font> dat<font color="#990000">-&gt;</font>principal_times<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">(),</font> dat<font color="#990000">-&gt;</font>principal_times<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">()</font> <font color="#990000">);</font>

      <font color="#009900">int</font> counter<font color="#990000">;</font>
      <b><font color="#0000FF">for</font></b><font color="#990000">(</font>counter <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> counter <font color="#990000">&lt;</font> numberOfPrincipal<font color="#990000">;</font> counter<font color="#990000">++)</font>
      <font color="#FF0000">{</font>
        dat<font color="#990000">-&gt;</font>principal_times<font color="#990000">.</font><b><font color="#000000">push_back</font></b><font color="#990000">(</font>firstPrincipal<font color="#990000">);</font>
        dat<font color="#990000">-&gt;</font>principal<font color="#990000">.</font><b><font color="#000000">push_back</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>UseP<font color="#990000">);</font> 

        <b><font color="#0000FF">if</font></b><font color="#990000">(</font> pperiodicity <font color="#990000">)</font>
          firstPrincipal <font color="#990000">+=</font>  <font color="#990000">(</font><font color="#009900">double</font><font color="#990000">)</font> <font color="#993399">1</font> <font color="#990000">/</font> pperiodicity<font color="#990000">;</font>
      <font color="#FF0000">}</font>

    <font color="#FF0000">}</font>
    <i><font color="#9A1900">//</font></i>

    <b><font color="#0000FF">if</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>debug<font color="#990000">)</font>
    <font color="#FF0000">{</font>
      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"coupon = "</font><font color="#990000">);</font>
      
      <b><font color="#0000FF">for</font></b><font color="#990000">(</font> std<font color="#990000">::</font>vector<font color="#990000">&lt;</font><font color="#009900">double</font><font color="#990000">&gt;::</font><font color="#008080">iterator</font> it <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">();</font> it <font color="#990000">!=</font> dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">();</font> <font color="#990000">++</font>it<font color="#990000">)</font>
      <font color="#FF0000">{</font>
        <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"%lf "</font><font color="#990000">,</font> <font color="#990000">*</font>it<font color="#990000">);</font>
      <font color="#FF0000">}</font>

      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">coupon times = "</font><font color="#990000">);</font>

      <b><font color="#0000FF">for</font></b><font color="#990000">(</font> std<font color="#990000">::</font>vector<font color="#990000">&lt;</font><font color="#009900">double</font><font color="#990000">&gt;::</font><font color="#008080">iterator</font> it <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">();</font> it <font color="#990000">!=</font> dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">();</font> <font color="#990000">++</font>it<font color="#990000">)</font>
      <font color="#FF0000">{</font>
        <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"%lf "</font><font color="#990000">,</font> <font color="#990000">*</font>it<font color="#990000">);</font>
      <font color="#FF0000">}</font>

      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">);</font>
      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"principal = "</font><font color="#990000">);</font>
      
      <b><font color="#0000FF">for</font></b><font color="#990000">(</font> std<font color="#990000">::</font>vector<font color="#990000">&lt;</font><font color="#009900">double</font><font color="#990000">&gt;::</font><font color="#008080">iterator</font> it <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>principal<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">();</font> it <font color="#990000">!=</font> dat<font color="#990000">-&gt;</font>principal<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">();</font> <font color="#990000">++</font>it<font color="#990000">)</font>
      <font color="#FF0000">{</font>
        <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"%lf "</font><font color="#990000">,</font> <font color="#990000">*</font>it<font color="#990000">);</font>
      <font color="#FF0000">}</font>

      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">principal times = "</font><font color="#990000">);</font>
      <b><font color="#0000FF">for</font></b><font color="#990000">(</font> std<font color="#990000">::</font>vector<font color="#990000">&lt;</font><font color="#009900">double</font><font color="#990000">&gt;::</font><font color="#008080">iterator</font> it <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>principal_times_adjusted<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">();</font> it <font color="#990000">!=</font> dat<font color="#990000">-&gt;</font>principal_times_adjusted<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">();</font> <font color="#990000">++</font>it<font color="#990000">)</font>
      <font color="#FF0000">{</font>
        <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"%lf "</font><font color="#990000">,</font> <font color="#990000">*</font>it<font color="#990000">);</font>
      <font color="#FF0000">}</font>

      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>

    dat<font color="#990000">-&gt;</font>bond_price <font color="#990000">=</font> <b><font color="#000000">bonds_price</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font> dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>principal_times_adjusted<font color="#990000">,</font> dat<font color="#990000">-&gt;</font>principal<font color="#990000">,</font> rate<font color="#990000">);</font>

    <b><font color="#000000">pthread_mutex_unlock</font></b><font color="#990000">(&amp;</font>dat<font color="#990000">-&gt;</font>mutexCashflow<font color="#990000">);</font>
    
    <font color="#FF0000">}</font>

    <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

  <b><font color="#0000FF">case</font></b> IRR<font color="#990000">:</font>

    <i><font color="#9A1900">//g_print("Internal Rate of Return\n");</font></i>

    <b><font color="#000000">pthread_mutex_lock</font></b><font color="#990000">(&amp;</font>dat<font color="#990000">-&gt;</font>mutexCashflow<font color="#990000">);</font>

    <b><font color="#0000FF">if</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>debug<font color="#990000">)</font>
    <font color="#FF0000">{</font>
      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"cash flows = "</font><font color="#990000">);</font>
      
      <b><font color="#0000FF">for</font></b><font color="#990000">(</font> std<font color="#990000">::</font>vector<font color="#990000">&lt;</font><font color="#009900">double</font><font color="#990000">&gt;::</font><font color="#008080">iterator</font> it <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">();</font> it <font color="#990000">!=</font> dat<font color="#990000">-&gt;</font>coupon<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">();</font> <font color="#990000">++</font>it<font color="#990000">)</font>
      <font color="#FF0000">{</font>
        <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"%lf "</font><font color="#990000">,</font> <font color="#990000">*</font>it<font color="#990000">);</font>
      <font color="#FF0000">}</font>

      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">times = "</font><font color="#990000">);</font>

      <b><font color="#0000FF">for</font></b><font color="#990000">(</font> std<font color="#990000">::</font>vector<font color="#990000">&lt;</font><font color="#009900">double</font><font color="#990000">&gt;::</font><font color="#008080">iterator</font> it <font color="#990000">=</font> dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">.</font><b><font color="#000000">begin</font></b><font color="#990000">();</font> it <font color="#990000">!=</font> dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">.</font><b><font color="#000000">end</font></b><font color="#990000">();</font> <font color="#990000">++</font>it<font color="#990000">)</font>
      <font color="#FF0000">{</font>
        <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"%lf "</font><font color="#990000">,</font> <font color="#990000">*</font>it<font color="#990000">);</font>
      <font color="#FF0000">}</font>

      <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>

    dat<font color="#990000">-&gt;</font>pv_continous <font color="#990000">=</font> <b><font color="#000000">cash_flow_pv</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>rate<font color="#990000">);</font>
    dat<font color="#990000">-&gt;</font>pv_discrete <font color="#990000">=</font> <b><font color="#000000">cash_flow_pv_discrete</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">,</font>rate<font color="#990000">);</font>
    dat<font color="#990000">-&gt;</font>irr_discrete <font color="#990000">=</font> <b><font color="#000000">cash_flow_irr_discrete</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">);</font>
    dat<font color="#990000">-&gt;</font>irr <font color="#990000">=</font> <b><font color="#000000">cash_flow_irr</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">);</font>
    dat<font color="#990000">-&gt;</font>uirr <font color="#990000">=</font> <b><font color="#000000">cash_flow_unique_irr</font></b><font color="#990000">(</font>dat<font color="#990000">-&gt;</font>coupon_times_adjusted<font color="#990000">,</font>dat<font color="#990000">-&gt;</font>coupon<font color="#990000">);</font>

    <b><font color="#000000">pthread_mutex_unlock</font></b><font color="#990000">(&amp;</font>dat<font color="#990000">-&gt;</font>mutexCashflow<font color="#990000">);</font>

    <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900">  case EURBOND_HO_LEE:</font></i>
<i><font color="#9A1900">    {</font></i>

<i><font color="#9A1900">    static int term_struct_eurbond_ho_lee = -1;</font></i>
<i><font color="#9A1900">    int term_selected = dat-&gt;UsePound-1;</font></i>

<i><font color="#9A1900">    if( term_selected != term_struct_eurbond_ho_lee )</font></i>
<i><font color="#9A1900">    {</font></i>
<i><font color="#9A1900">      term_struct_eurbond_ho_lee = term_selected;</font></i>
<i><font color="#9A1900">      //g_print("EURBOND_HO_LEE: term struct changed\n");</font></i>

<i><font color="#9A1900">      on_comboboxModel_changed_hide(term_structure_list[dat-&gt;UsePound-1].modeltype,p);</font></i>
<i><font color="#9A1900">      on_comboboxModel_changed_show(term_structure_list[dat-&gt;UsePound-1].modeltype,p);</font></i>
<i><font color="#9A1900">      updateTime(term_structure_list[dat-&gt;UsePound-1].modeltype,p);</font></i>
<i><font color="#9A1900">      updateVolatility(term_structure_list[dat-&gt;UsePound-1].modeltype,p);</font></i>

<i><font color="#9A1900">      gtk_widget_show(p-&gt;GtkInfo.spinbuttonUseS);</font></i>
<i><font color="#9A1900">      gtk_widget_show(p-&gt;GtkInfo.labelUseS);</font></i>
<i><font color="#9A1900">      gtk_widget_show(p-&gt;GtkInfo.spinbuttonUseT);</font></i>
<i><font color="#9A1900">      gtk_widget_show(p-&gt;GtkInfo.labelUseT);</font></i>
<i><font color="#9A1900">      gtk_widget_show(p-&gt;GtkInfo.label3);</font></i>
<i><font color="#9A1900">      gtk_widget_show(p-&gt;GtkInfo.labelPrice);</font></i>
<i><font color="#9A1900">      gtk_widget_show(p-&gt;GtkInfo.spinbuttonPrice);</font></i>
<i><font color="#9A1900">    }</font></i>

<i><font color="#9A1900">    struct _data termstructuredata;</font></i>
<i><font color="#9A1900">    p-&gt;data.term_model = term_structure_list[dat-&gt;UsePound-1].modeltype;</font></i>
<i><font color="#9A1900">    termstructuredata = termstructure(&amp;p-&gt;data);</font></i>

<i><font color="#9A1900">    pthread_mutex_lock(&amp;dat-&gt;mutexCashflow);</font></i>

<i><font color="#9A1900">    if(dat-&gt;debug)</font></i>
<i><font color="#9A1900">    {</font></i>
<i><font color="#9A1900">      g_print("coupons = ");</font></i>
<i><font color="#9A1900">      </font></i>
<i><font color="#9A1900">      for( std::vector&lt;double&gt;::iterator it = dat-&gt;coupon.begin(); it != dat-&gt;coupon.end(); ++it)</font></i>
<i><font color="#9A1900">      {</font></i>
<i><font color="#9A1900">        g_print("%lf ", *it);</font></i>
<i><font color="#9A1900">      }</font></i>
<i><font color="#9A1900">      g_print("\ntimes = ");</font></i>

<i><font color="#9A1900">      for( std::vector&lt;double&gt;::iterator it = dat-&gt;coupon_times_adjusted.begin(); it != dat-&gt;coupon_times_adjusted.end(); ++it)</font></i>
<i><font color="#9A1900">      {</font></i>
<i><font color="#9A1900">        g_print("%lf ", *it);</font></i>
<i><font color="#9A1900">      }</font></i>

<i><font color="#9A1900">      g_print("\n");</font></i>
<i><font color="#9A1900">    }</font></i>

<i><font color="#9A1900">    if(dat-&gt;debug)</font></i>
<i><font color="#9A1900">        logger( (char *)"price_european_call_option_on_bond_using_ho_lee", 6,</font></i>
<i><font color="#9A1900">                                                    (double) dat-&gt;UseS, </font></i>
<i><font color="#9A1900">                                                    (double) dat-&gt;UseT,</font></i>
<i><font color="#9A1900">                                                    (double) 0,</font></i>
<i><font color="#9A1900">                                                    (double) 0,</font></i>
<i><font color="#9A1900">                                                    (double) dat-&gt;price, </font></i>
<i><font color="#9A1900">                                                    (double) t3);</font></i>

<i><font color="#9A1900">    dat-&gt;call = price_european_call_option_on_bond_using_ho_lee(</font></i>
<i><font color="#9A1900">                                                    dat-&gt;term,</font></i>
<i><font color="#9A1900">                                                    dat-&gt;UseS,</font></i>
<i><font color="#9A1900">                                                    dat-&gt;UseT,</font></i>
<i><font color="#9A1900">                                                    dat-&gt;coupon_times_adjusted,</font></i>
<i><font color="#9A1900">                                                    dat-&gt;coupon,</font></i>
<i><font color="#9A1900">                                                    dat-&gt;price,</font></i>
<i><font color="#9A1900">                                                    t3);</font></i>

<i><font color="#9A1900">    delete dat-&gt;term;</font></i>

<i><font color="#9A1900">    pthread_mutex_unlock(&amp;dat-&gt;mutexCashflow);</font></i>

<i><font color="#9A1900">    }</font></i>

<i><font color="#9A1900">    break;</font></i>
<i><font color="#9A1900">*/</font></i>

<b><font color="#000080">#endif</font></b>

<b><font color="#008080">  default:</font></b>

      <b><font color="#000000">fprintf</font></b><font color="#990000">(</font>stderr<font color="#990000">,</font><font color="#FF0000">"bonddispatch(): No implementation for case %d</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font>dat<font color="#990000">-&gt;</font>modeltype<font color="#990000">);</font>

      <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
  <font color="#FF0000">}</font>

  <font color="#FF0000">}</font>
  <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>exception<font color="#990000">&amp;</font> e<font color="#990000">)</font>
  <font color="#FF0000">{</font>
    <b><font color="#000000">g_print</font></b><font color="#990000">(</font><font color="#FF0000">"bonddispatch(): Exception caught: %s</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> e<font color="#990000">.</font><b><font color="#000000">what</font></b><font color="#990000">()</font> <font color="#990000">);</font>

    <i><font color="#9A1900">// program might not be recoverable...</font></i>
    <b><font color="#000000">fflush</font></b><font color="#990000">(</font>NULL<font color="#990000">);</font>
  <font color="#FF0000">}</font>

  <b><font color="#0000FF">return</font></b> <font color="#990000">*</font>dat<font color="#990000">;</font>
<font color="#FF0000">}</font>
</tt></pre>
