<!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900">    libmetaoptions - A collection of option-related functions. </font></i>
<i><font color="#9A1900">    Copyright (C) 2000-2004 B. Augestad, </font></i><u><font color="#0000FF">bjorn.augestad@gmail.com</font></u><i><font color="#9A1900"> </font></i>

<i><font color="#9A1900">    This program is free software; you can redistribute it and/or modify</font></i>
<i><font color="#9A1900">    it under the terms of the GNU General Public License as published by</font></i>
<i><font color="#9A1900">    the Free Software Foundation; either version 2 of the License, or</font></i>
<i><font color="#9A1900">    (at your option) any later version.</font></i>

<i><font color="#9A1900">    This program is distributed in the hope that it will be useful,</font></i>
<i><font color="#9A1900">    but WITHOUT ANY WARRANTY; without even the implied warranty of</font></i>
<i><font color="#9A1900">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</font></i>
<i><font color="#9A1900">    GNU General Public License for more details.</font></i>

<i><font color="#9A1900">    You should have received a copy of the GNU General Public License</font></i>
<i><font color="#9A1900">    along with this program; if not, write to the Free Software</font></i>
<i><font color="#9A1900">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</font></i>
<i><font color="#9A1900">*/</font></i>

<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;math.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;string.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;stdlib.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;assert.h&gt;</font>

<b><font color="#000080">#include</font></b> <font color="#FF0000">"metaoptions.h"</font>

<i><font color="#9A1900">/* Performance notes.</font></i>
<i><font color="#9A1900"> * Calls/sec	Action</font></i>
<i><font color="#9A1900"> *  31.000		Minor cleanup</font></i>
<i><font color="#9A1900"> *  31.000		Making typeflag an int</font></i>
<i><font color="#9A1900"> *  31.000		Replacing if/elseif with switch and removing the variable named result.</font></i>
<i><font color="#9A1900"> *  25.424		New and slower laptop machine</font></i>
<i><font color="#9A1900"> *  25.000		Changed a couple of literals from e.g. 2 to 2.0</font></i>
<i><font color="#9A1900"> *  11.500		WTF?</font></i>
<i><font color="#9A1900"> */</font></i>

<i><font color="#9A1900">/* Double barrier options */</font></i>
<font color="#009900">double</font> <b><font color="#000000">DoubleBarrier</font></b><font color="#990000">(</font>
	<font color="#009900">int</font> typeflag<font color="#990000">,</font>
	<font color="#009900">double</font> S<font color="#990000">,</font>
	<font color="#009900">double</font> X<font color="#990000">,</font>
	<font color="#009900">double</font> L<font color="#990000">,</font>
	<font color="#009900">double</font> U<font color="#990000">,</font>
	<font color="#009900">double</font> T<font color="#990000">,</font>
	<font color="#009900">double</font> r<font color="#990000">,</font>
	<font color="#009900">double</font> b<font color="#990000">,</font>
	<font color="#009900">double</font> v<font color="#990000">,</font>
	<font color="#009900">double</font> delta1<font color="#990000">,</font>
	<font color="#009900">double</font> delta2<font color="#990000">)</font> 
<font color="#FF0000">{</font>
	<font color="#009900">int</font> n<font color="#990000">;</font>

	<font color="#009900">double</font> vst<font color="#990000">,</font> p2v<font color="#990000">,</font> F<font color="#990000">,</font> E<font color="#990000">,</font> dd<font color="#990000">,</font> LS<font color="#990000">;</font>
    <font color="#009900">double</font> outval<font color="#990000">,</font> Sum1 <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">,</font> Sum2 <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>

	<b><font color="#000000">assert_valid_price</font></b><font color="#990000">(</font>S<font color="#990000">);</font>
	<b><font color="#000000">assert_valid_strike</font></b><font color="#990000">(</font>X<font color="#990000">);</font>
	<b><font color="#000000">assert_valid_time</font></b><font color="#990000">(</font>T<font color="#990000">);</font>
	<b><font color="#000000">assert_valid_interest_rate</font></b><font color="#990000">(</font>r<font color="#990000">);</font>
	<b><font color="#000000">assert_valid_cost_of_carry</font></b><font color="#990000">(</font>b<font color="#990000">);</font>
	<b><font color="#000000">assert_valid_volatility</font></b><font color="#990000">(</font>v<font color="#990000">);</font>

	vst <font color="#990000">=</font> v <font color="#990000">*</font> <b><font color="#000000">sqrt</font></b><font color="#990000">(</font>T<font color="#990000">);</font>
	p2v <font color="#990000">=</font> <b><font color="#000000">pow2</font></b><font color="#990000">(</font>v<font color="#990000">);</font>
    
    F <font color="#990000">=</font> U <font color="#990000">*</font> <b><font color="#000000">exp</font></b><font color="#990000">(</font>delta1 <font color="#990000">*</font> T<font color="#990000">);</font>
    E <font color="#990000">=</font> L <font color="#990000">*</font> <b><font color="#000000">exp</font></b><font color="#990000">(</font>delta2 <font color="#990000">*</font> T<font color="#990000">);</font>
	dd <font color="#990000">=</font> delta1 <font color="#990000">-</font> delta2<font color="#990000">;</font>
	LS <font color="#990000">=</font> L <font color="#990000">/</font> S<font color="#990000">;</font>

    <b><font color="#0000FF">if</font></b><font color="#990000">(</font>typeflag <font color="#990000">==</font> DB_CALL_OUT <font color="#990000">||</font> typeflag <font color="#990000">==</font> DB_CALL_IN<font color="#990000">)</font> <font color="#FF0000">{</font> 
        <b><font color="#0000FF">for</font></b><font color="#990000">(</font>n <font color="#990000">=</font> <font color="#990000">-</font><font color="#993399">5</font><font color="#990000">;</font> n <font color="#990000">&lt;=</font> <font color="#993399">5</font><font color="#990000">;</font> n<font color="#990000">++)</font> <font color="#FF0000">{</font>
			<font color="#009900">double</font> powL2n <font color="#990000">=</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>L<font color="#990000">,</font> <font color="#990000">(</font><font color="#993399">2.0</font> <font color="#990000">*</font> n<font color="#990000">));</font>
			<font color="#009900">double</font> SpowU2n <font color="#990000">=</font> S <font color="#990000">*</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>U<font color="#990000">,</font> <font color="#990000">(</font><font color="#993399">2.0</font> <font color="#990000">*</font> n<font color="#990000">));</font>
			<font color="#009900">double</font> powLn <font color="#990000">=</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>L<font color="#990000">,</font> n<font color="#990000">);</font>
			<font color="#009900">double</font> powUn <font color="#990000">=</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>U<font color="#990000">,</font> n<font color="#990000">);</font>
			<font color="#009900">double</font> bp2v2T <font color="#990000">=</font> <font color="#990000">(</font>b <font color="#990000">+</font> p2v <font color="#990000">/</font> <font color="#993399">2.0</font><font color="#990000">)</font> <font color="#990000">*</font> T<font color="#990000">;</font>

            <font color="#009900">double</font> d1 <font color="#990000">=</font> <font color="#990000">(</font><b><font color="#000000">log</font></b><font color="#990000">(</font>SpowU2n <font color="#990000">/</font> <font color="#990000">(</font>X <font color="#990000">*</font> powL2n<font color="#990000">))</font> <font color="#990000">+</font> bp2v2T<font color="#990000">)</font> <font color="#990000">/</font> vst<font color="#990000">;</font>
            <font color="#009900">double</font> d2 <font color="#990000">=</font> <font color="#990000">(</font><b><font color="#000000">log</font></b><font color="#990000">(</font>SpowU2n <font color="#990000">/</font> <font color="#990000">(</font>F <font color="#990000">*</font> powL2n<font color="#990000">))</font> <font color="#990000">+</font> bp2v2T<font color="#990000">)</font> <font color="#990000">/</font> vst<font color="#990000">;</font>
            <font color="#009900">double</font> d3 <font color="#990000">=</font> <font color="#990000">(</font><b><font color="#000000">log</font></b><font color="#990000">(</font><b><font color="#000000">pow</font></b><font color="#990000">(</font>L<font color="#990000">,</font> <font color="#990000">(</font><font color="#993399">2.0</font> <font color="#990000">*</font> n <font color="#990000">+</font> <font color="#993399">2.0</font><font color="#990000">))</font> <font color="#990000">/</font> <font color="#990000">(</font>X <font color="#990000">*</font> SpowU2n<font color="#990000">))</font> <font color="#990000">+</font> bp2v2T<font color="#990000">)</font> <font color="#990000">/</font> vst<font color="#990000">;</font>
            <font color="#009900">double</font> d4 <font color="#990000">=</font> <font color="#990000">(</font><b><font color="#000000">log</font></b><font color="#990000">(</font><b><font color="#000000">pow</font></b><font color="#990000">(</font>L<font color="#990000">,</font> <font color="#990000">(</font><font color="#993399">2.0</font> <font color="#990000">*</font> n <font color="#990000">+</font> <font color="#993399">2.0</font><font color="#990000">))</font> <font color="#990000">/</font> <font color="#990000">(</font>F <font color="#990000">*</font> SpowU2n<font color="#990000">))</font> <font color="#990000">+</font> bp2v2T<font color="#990000">)</font> <font color="#990000">/</font> vst<font color="#990000">;</font>

            <font color="#009900">double</font> mu1 <font color="#990000">=</font> <font color="#993399">2.0</font> <font color="#990000">*</font> <font color="#990000">(</font>b <font color="#990000">-</font> delta2 <font color="#990000">-</font> n <font color="#990000">*</font> dd<font color="#990000">)</font> <font color="#990000">/</font> p2v <font color="#990000">+</font> <font color="#993399">1.0</font><font color="#990000">;</font>
            <font color="#009900">double</font> mu2 <font color="#990000">=</font> <font color="#993399">2.0</font> <font color="#990000">*</font> n <font color="#990000">*</font> dd <font color="#990000">/</font> p2v<font color="#990000">;</font>
            <font color="#009900">double</font> mu3 <font color="#990000">=</font> <font color="#993399">2.0</font> <font color="#990000">*</font> <font color="#990000">(</font>b <font color="#990000">-</font> delta2 <font color="#990000">+</font> n <font color="#990000">*</font> dd<font color="#990000">)</font> <font color="#990000">/</font> p2v <font color="#990000">+</font> <font color="#993399">1.0</font><font color="#990000">;</font>

            Sum1 <font color="#990000">+=</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>powUn <font color="#990000">/</font> powLn<font color="#990000">,</font> mu1<font color="#990000">)</font> <font color="#990000">*</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>LS<font color="#990000">,</font> mu2<font color="#990000">)</font> <font color="#990000">*</font> <font color="#990000">(</font><b><font color="#000000">cnd</font></b><font color="#990000">(</font>d1<font color="#990000">)</font> <font color="#990000">-</font> <b><font color="#000000">cnd</font></b><font color="#990000">(</font>d2<font color="#990000">))</font> 
				<font color="#990000">-</font> <b><font color="#000000">pow</font></b><font color="#990000">((</font><b><font color="#000000">pow</font></b><font color="#990000">(</font>L<font color="#990000">,</font> <font color="#990000">(</font>n <font color="#990000">+</font> <font color="#993399">1.0</font><font color="#990000">))</font> <font color="#990000">/</font> <font color="#990000">(</font>powUn <font color="#990000">*</font> S<font color="#990000">)),</font> mu3<font color="#990000">)</font> <font color="#990000">*</font> <font color="#990000">(</font><b><font color="#000000">cnd</font></b><font color="#990000">(</font>d3<font color="#990000">)</font> <font color="#990000">-</font> <b><font color="#000000">cnd</font></b><font color="#990000">(</font>d4<font color="#990000">));</font>

            Sum2 <font color="#990000">+=</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>powUn <font color="#990000">/</font> powLn<font color="#990000">,</font> <font color="#990000">(</font>mu1 <font color="#990000">-</font> <font color="#993399">2.0</font><font color="#990000">))</font> <font color="#990000">*</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>LS<font color="#990000">,</font> mu2<font color="#990000">)</font> <font color="#990000">*</font> <font color="#990000">(</font><b><font color="#000000">cnd</font></b><font color="#990000">(</font>d1 <font color="#990000">-</font> vst<font color="#990000">)</font> <font color="#990000">-</font> <b><font color="#000000">cnd</font></b><font color="#990000">(</font>d2 <font color="#990000">-</font> vst<font color="#990000">))</font> 
				<font color="#990000">-</font> <b><font color="#000000">pow</font></b><font color="#990000">((</font><b><font color="#000000">pow</font></b><font color="#990000">(</font>L<font color="#990000">,</font> <font color="#990000">(</font>n <font color="#990000">+</font> <font color="#993399">1.0</font><font color="#990000">))</font> <font color="#990000">/</font> <font color="#990000">(</font>powUn <font color="#990000">*</font> S<font color="#990000">)),</font> <font color="#990000">(</font>mu3 <font color="#990000">-</font> <font color="#993399">2.0</font><font color="#990000">))</font> <font color="#990000">*</font> <font color="#990000">(</font><b><font color="#000000">cnd</font></b><font color="#990000">(</font>d3 <font color="#990000">-</font> vst<font color="#990000">)</font> <font color="#990000">-</font> <b><font color="#000000">cnd</font></b><font color="#990000">(</font>d4 <font color="#990000">-</font> vst<font color="#990000">));</font>
        <font color="#FF0000">}</font>

        outval <font color="#990000">=</font> S <font color="#990000">*</font> <b><font color="#000000">exp</font></b><font color="#990000">((</font>b <font color="#990000">-</font> r<font color="#990000">)</font> <font color="#990000">*</font> T<font color="#990000">)</font> <font color="#990000">*</font> Sum1 <font color="#990000">-</font> X <font color="#990000">*</font> <b><font color="#000000">exp</font></b><font color="#990000">(-</font>r <font color="#990000">*</font> T<font color="#990000">)</font> <font color="#990000">*</font> Sum2<font color="#990000">;</font>
    <font color="#FF0000">}</font>
	<b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b><font color="#990000">(</font>typeflag <font color="#990000">==</font> DB_PUT_IN <font color="#990000">||</font> typeflag <font color="#990000">==</font> DB_PUT_OUT<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">for</font></b><font color="#990000">(</font>n <font color="#990000">=</font> <font color="#990000">-</font><font color="#993399">5</font><font color="#990000">;</font> n <font color="#990000">&lt;=</font> <font color="#993399">5</font><font color="#990000">;</font> n<font color="#990000">++)</font> <font color="#FF0000">{</font>
			<font color="#009900">double</font> powL2n <font color="#990000">=</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>L<font color="#990000">,</font> <font color="#993399">2.0</font> <font color="#990000">*</font> n<font color="#990000">);</font>
			<font color="#009900">double</font> SpowU2n <font color="#990000">=</font> S <font color="#990000">*</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>U<font color="#990000">,</font> <font color="#993399">2.0</font> <font color="#990000">*</font> n<font color="#990000">);</font>
			<font color="#009900">double</font> powLn <font color="#990000">=</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>L<font color="#990000">,</font> n<font color="#990000">);</font>
			<font color="#009900">double</font> powUn <font color="#990000">=</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>U<font color="#990000">,</font> n<font color="#990000">);</font>
			<font color="#009900">double</font> bp2v2T <font color="#990000">=</font> <font color="#990000">(</font>b <font color="#990000">+</font> p2v <font color="#990000">/</font> <font color="#993399">2.0</font><font color="#990000">)</font> <font color="#990000">*</font> T<font color="#990000">;</font>

            <font color="#009900">double</font> d1 <font color="#990000">=</font> <font color="#990000">(</font><b><font color="#000000">log</font></b><font color="#990000">(</font>SpowU2n <font color="#990000">/</font> <font color="#990000">(</font>E <font color="#990000">*</font> powL2n<font color="#990000">))</font> <font color="#990000">+</font> bp2v2T<font color="#990000">)</font> <font color="#990000">/</font> vst<font color="#990000">;</font>
            <font color="#009900">double</font> d2 <font color="#990000">=</font> <font color="#990000">(</font><b><font color="#000000">log</font></b><font color="#990000">(</font>SpowU2n <font color="#990000">/</font> <font color="#990000">(</font>X <font color="#990000">*</font> powL2n<font color="#990000">))</font> <font color="#990000">+</font> bp2v2T<font color="#990000">)</font> <font color="#990000">/</font> vst<font color="#990000">;</font>
            <font color="#009900">double</font> d3 <font color="#990000">=</font> <font color="#990000">(</font><b><font color="#000000">log</font></b><font color="#990000">(</font><b><font color="#000000">pow</font></b><font color="#990000">(</font>L<font color="#990000">,</font> <font color="#990000">(</font><font color="#993399">2.0</font> <font color="#990000">*</font> n <font color="#990000">+</font> <font color="#993399">2.0</font><font color="#990000">))</font> <font color="#990000">/</font> <font color="#990000">(</font>E <font color="#990000">*</font> SpowU2n<font color="#990000">))</font> <font color="#990000">+</font> bp2v2T<font color="#990000">)</font> <font color="#990000">/</font> vst<font color="#990000">;</font>
            <font color="#009900">double</font> d4 <font color="#990000">=</font> <font color="#990000">(</font><b><font color="#000000">log</font></b><font color="#990000">(</font><b><font color="#000000">pow</font></b><font color="#990000">(</font>L<font color="#990000">,</font> <font color="#990000">(</font><font color="#993399">2.0</font> <font color="#990000">*</font> n <font color="#990000">+</font> <font color="#993399">2.0</font><font color="#990000">))</font> <font color="#990000">/</font> <font color="#990000">(</font>X <font color="#990000">*</font> SpowU2n<font color="#990000">))</font> <font color="#990000">+</font> bp2v2T<font color="#990000">)</font> <font color="#990000">/</font> vst<font color="#990000">;</font>

            <font color="#009900">double</font> mu1 <font color="#990000">=</font> <font color="#993399">2.0</font> <font color="#990000">*</font> <font color="#990000">(</font>b <font color="#990000">-</font> delta2 <font color="#990000">-</font> n <font color="#990000">*</font> dd<font color="#990000">)</font> <font color="#990000">/</font> p2v <font color="#990000">+</font> <font color="#993399">1.0</font><font color="#990000">;</font>
            <font color="#009900">double</font> mu2 <font color="#990000">=</font> <font color="#993399">2.0</font> <font color="#990000">*</font> n <font color="#990000">*</font> dd <font color="#990000">/</font> p2v<font color="#990000">;</font>
            <font color="#009900">double</font> mu3 <font color="#990000">=</font> <font color="#993399">2.0</font> <font color="#990000">*</font> <font color="#990000">(</font>b <font color="#990000">-</font> delta2 <font color="#990000">+</font> n <font color="#990000">*</font> dd<font color="#990000">)</font> <font color="#990000">/</font> p2v <font color="#990000">+</font> <font color="#993399">1.0</font><font color="#990000">;</font>

            Sum1 <font color="#990000">+=</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>powUn <font color="#990000">/</font> powLn<font color="#990000">,</font> mu1<font color="#990000">)</font> <font color="#990000">*</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>LS<font color="#990000">,</font> mu2<font color="#990000">)</font> <font color="#990000">*</font> <font color="#990000">(</font><b><font color="#000000">cnd</font></b><font color="#990000">(</font>d1<font color="#990000">)</font> <font color="#990000">-</font> <b><font color="#000000">cnd</font></b><font color="#990000">(</font>d2<font color="#990000">))</font>
				 <font color="#990000">-</font> <b><font color="#000000">pow</font></b><font color="#990000">((</font><b><font color="#000000">pow</font></b><font color="#990000">(</font>L<font color="#990000">,</font> n <font color="#990000">+</font> <font color="#993399">1.0</font><font color="#990000">)</font> <font color="#990000">/</font> <font color="#990000">(</font>powUn <font color="#990000">*</font> S<font color="#990000">)),</font> mu3<font color="#990000">)</font> <font color="#990000">*</font> <font color="#990000">(</font><b><font color="#000000">cnd</font></b><font color="#990000">(</font>d3<font color="#990000">)</font> <font color="#990000">-</font> <b><font color="#000000">cnd</font></b><font color="#990000">(</font>d4<font color="#990000">));</font>

            Sum2 <font color="#990000">+=</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>powUn <font color="#990000">/</font> powLn<font color="#990000">,</font> <font color="#990000">(</font>mu1 <font color="#990000">-</font> <font color="#993399">2.0</font><font color="#990000">))</font> <font color="#990000">*</font> <b><font color="#000000">pow</font></b><font color="#990000">(</font>LS<font color="#990000">,</font> mu2<font color="#990000">)</font> <font color="#990000">*</font> <font color="#990000">(</font><b><font color="#000000">cnd</font></b><font color="#990000">(</font>d1 <font color="#990000">-</font> vst<font color="#990000">)</font> <font color="#990000">-</font> <b><font color="#000000">cnd</font></b><font color="#990000">(</font>d2 <font color="#990000">-</font> vst<font color="#990000">))</font>
				<font color="#990000">-</font> <b><font color="#000000">pow</font></b><font color="#990000">((</font><b><font color="#000000">pow</font></b><font color="#990000">(</font>L<font color="#990000">,</font> n <font color="#990000">+</font> <font color="#993399">1.0</font><font color="#990000">)</font> <font color="#990000">/</font> <font color="#990000">(</font>powUn <font color="#990000">*</font> S<font color="#990000">)),</font> <font color="#990000">(</font>mu3 <font color="#990000">-</font> <font color="#993399">2.0</font><font color="#990000">))</font> <font color="#990000">*</font> <font color="#990000">(</font><b><font color="#000000">cnd</font></b><font color="#990000">(</font>d3 <font color="#990000">-</font> vst<font color="#990000">)</font> <font color="#990000">-</font> <b><font color="#000000">cnd</font></b><font color="#990000">(</font>d4 <font color="#990000">-</font> vst<font color="#990000">));</font>
        <font color="#FF0000">}</font>

        outval <font color="#990000">=</font> X <font color="#990000">*</font> <b><font color="#000000">exp</font></b><font color="#990000">(-</font>r <font color="#990000">*</font> T<font color="#990000">)</font> <font color="#990000">*</font> Sum2 <font color="#990000">-</font> S <font color="#990000">*</font> <b><font color="#000000">exp</font></b><font color="#990000">((</font>b <font color="#990000">-</font> r<font color="#990000">)</font> <font color="#990000">*</font> T<font color="#990000">)</font> <font color="#990000">*</font> Sum1<font color="#990000">;</font>
    <font color="#FF0000">}</font>
	<b><font color="#0000FF">else</font></b>
		<b><font color="#000000">abort</font></b><font color="#990000">();</font>

	<b><font color="#0000FF">switch</font></b><font color="#990000">(</font>typeflag<font color="#990000">)</font> <font color="#FF0000">{</font>
		<b><font color="#0000FF">case</font></b> DB_CALL_OUT<font color="#990000">:</font>
		<b><font color="#0000FF">case</font></b> DB_PUT_OUT<font color="#990000">:</font> <b><font color="#0000FF">return</font></b> outval<font color="#990000">;</font>
        <b><font color="#0000FF">case</font></b> DB_CALL_IN<font color="#990000">:</font> <b><font color="#0000FF">return</font></b> <b><font color="#000000">gbs_call</font></b><font color="#990000">(</font>S<font color="#990000">,</font> X<font color="#990000">,</font> T<font color="#990000">,</font> r<font color="#990000">,</font> b<font color="#990000">,</font> v<font color="#990000">)</font> <font color="#990000">-</font> outval<font color="#990000">;</font>
		<b><font color="#0000FF">case</font></b> DB_PUT_IN<font color="#990000">:</font> <b><font color="#0000FF">return</font></b> <b><font color="#000000">gbs_put</font></b><font color="#990000">(</font>S<font color="#990000">,</font> X<font color="#990000">,</font> T<font color="#990000">,</font> r<font color="#990000">,</font> b<font color="#990000">,</font> v<font color="#990000">)</font> <font color="#990000">-</font> outval<font color="#990000">;</font>
    	<b><font color="#0000FF">default</font></b><font color="#990000">:</font> <b><font color="#000000">abort</font></b><font color="#990000">();</font>
	<font color="#FF0000">}</font>
<font color="#FF0000">}</font>

<b><font color="#000080">#ifdef</font></b> DOUBLEBARRIER_CHECK
<i><font color="#9A1900">/* Page 72-76 */</font></i>
<b><font color="#0000FF">static</font></b> <font color="#009900">void</font> <b><font color="#000000">check_DoubleBarrier</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#009900">int</font> typeflag <font color="#990000">=</font> DB_CALL_OUT<font color="#990000">;</font>
	<font color="#009900">double</font> S <font color="#990000">=</font> <font color="#993399">100.0</font><font color="#990000">,</font> X <font color="#990000">=</font> <font color="#993399">100.0</font><font color="#990000">,</font> r <font color="#990000">=</font> <font color="#993399">0.10</font><font color="#990000">,</font> b <font color="#990000">=</font> <font color="#993399">0.10</font><font color="#990000">;</font>

	<i><font color="#9A1900">/* The table 2-10 contains a massive amount of test data, </font></i>
<i><font color="#9A1900">	 * 72 values for different combinations of T,v,L,U, delta1 and delta2.</font></i>
<i><font color="#9A1900">	 */</font></i>
	<b><font color="#0000FF">struct</font></b> <font color="#FF0000">{</font>
		<font color="#009900">double</font> L<font color="#990000">,</font> U<font color="#990000">,</font> d1<font color="#990000">,</font> d2<font color="#990000">;</font>
		<font color="#009900">double</font> fasit<font color="#990000">[</font><font color="#993399">2</font><font color="#990000">][</font><font color="#993399">3</font><font color="#990000">];</font>
	<font color="#FF0000">}</font> values<font color="#990000">[</font><font color="#993399">15</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#FF0000">{</font>
		<font color="#FF0000">{</font> <font color="#993399">50</font><font color="#990000">,</font> <font color="#993399">150</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font>      <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">4.3515</font><font color="#990000">,</font> <font color="#993399">6.1644</font><font color="#990000">,</font> <font color="#993399">7.0373</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">6.9853</font><font color="#990000">,</font> <font color="#993399">7.9336</font><font color="#990000">,</font> <font color="#993399">6.5088</font><font color="#FF0000">}}}</font><font color="#990000">,</font>
		<font color="#FF0000">{</font> <font color="#993399">60</font><font color="#990000">,</font> <font color="#993399">140</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font>      <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">4.3505</font><font color="#990000">,</font> <font color="#993399">5.8500</font><font color="#990000">,</font> <font color="#993399">5.7726</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">6.8082</font><font color="#990000">,</font> <font color="#993399">6.3383</font><font color="#990000">,</font> <font color="#993399">4.3841</font><font color="#FF0000">}}}</font><font color="#990000">,</font>
		<font color="#FF0000">{</font> <font color="#993399">70</font><font color="#990000">,</font> <font color="#993399">130</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font>      <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">4.3139</font><font color="#990000">,</font> <font color="#993399">4.8293</font><font color="#990000">,</font> <font color="#993399">3.7765</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">5.9697</font><font color="#990000">,</font> <font color="#993399">4.0004</font><font color="#990000">,</font> <font color="#993399">2.2563</font><font color="#FF0000">}}}</font><font color="#990000">,</font>
		<font color="#FF0000">{</font> <font color="#993399">80</font><font color="#990000">,</font> <font color="#993399">120</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font>      <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">3.7516</font><font color="#990000">,</font> <font color="#993399">2.6387</font><font color="#990000">,</font> <font color="#993399">1.4903</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">3.5805</font><font color="#990000">,</font> <font color="#993399">1.5098</font><font color="#990000">,</font> <font color="#993399">0.5635</font><font color="#FF0000">}}}</font><font color="#990000">,</font>
		<font color="#FF0000">{</font> <font color="#993399">90</font><font color="#990000">,</font> <font color="#993399">110</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font>      <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">1.2055</font><font color="#990000">,</font> <font color="#993399">0.3098</font><font color="#990000">,</font> <font color="#993399">0.0477</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">0.5537</font><font color="#990000">,</font> <font color="#993399">0.0441</font><font color="#990000">,</font> <font color="#993399">0.0011</font><font color="#FF0000">}}}</font><font color="#990000">,</font>

		<font color="#FF0000">{</font> <font color="#993399">50</font><font color="#990000">,</font> <font color="#993399">150</font><font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">0.1</font><font color="#990000">,</font> <font color="#993399">0.1</font><font color="#990000">,</font> <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">4.3514</font><font color="#990000">,</font> <font color="#993399">6.0997</font><font color="#990000">,</font> <font color="#993399">6.6987</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">6.8974</font><font color="#990000">,</font> <font color="#993399">6.9821</font><font color="#990000">,</font> <font color="#993399">5.2107</font><font color="#FF0000">}}}</font><font color="#990000">,</font>
		<font color="#FF0000">{</font> <font color="#993399">60</font><font color="#990000">,</font> <font color="#993399">140</font><font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">0.1</font><font color="#990000">,</font> <font color="#993399">0.1</font><font color="#990000">,</font> <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">4.3478</font><font color="#990000">,</font> <font color="#993399">5.6351</font><font color="#990000">,</font> <font color="#993399">5.2463</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">6.4094</font><font color="#990000">,</font> <font color="#993399">5.0199</font><font color="#990000">,</font> <font color="#993399">3.1503</font><font color="#FF0000">}}}</font><font color="#990000">,</font>
		<font color="#FF0000">{</font> <font color="#993399">70</font><font color="#990000">,</font> <font color="#993399">130</font><font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">0.1</font><font color="#990000">,</font> <font color="#993399">0.1</font><font color="#990000">,</font> <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">4.2558</font><font color="#990000">,</font> <font color="#993399">4.3291</font><font color="#990000">,</font> <font color="#993399">3.1540</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">4.8182</font><font color="#990000">,</font> <font color="#993399">2.6259</font><font color="#990000">,</font> <font color="#993399">1.3424</font><font color="#FF0000">}}}</font><font color="#990000">,</font>
		<font color="#FF0000">{</font> <font color="#993399">80</font><font color="#990000">,</font> <font color="#993399">120</font><font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">0.1</font><font color="#990000">,</font> <font color="#993399">0.1</font><font color="#990000">,</font> <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">3.2953</font><font color="#990000">,</font> <font color="#993399">1.9868</font><font color="#990000">,</font> <font color="#993399">1.0351</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">1.9245</font><font color="#990000">,</font> <font color="#993399">0.6455</font><font color="#990000">,</font> <font color="#993399">0.1817</font><font color="#FF0000">}}}</font><font color="#990000">,</font>
		<font color="#FF0000">{</font> <font color="#993399">90</font><font color="#990000">,</font> <font color="#993399">110</font><font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">0.1</font><font color="#990000">,</font> <font color="#993399">0.1</font><font color="#990000">,</font> <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">0.5887</font><font color="#990000">,</font> <font color="#993399">0.1016</font><font color="#990000">,</font> <font color="#993399">0.0085</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">0.0398</font><font color="#990000">,</font> <font color="#993399">0.0002</font><font color="#990000">,</font> <font color="#993399">0.0000</font><font color="#FF0000">}}}</font><font color="#990000">,</font>

		<font color="#FF0000">{</font> <font color="#993399">50</font><font color="#990000">,</font> <font color="#993399">150</font><font color="#990000">,</font> <font color="#993399">0.1</font><font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">0.1</font><font color="#990000">,</font> <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">4.3515</font><font color="#990000">,</font> <font color="#993399">6.2040</font><font color="#990000">,</font> <font color="#993399">7.3151</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">7.0086</font><font color="#990000">,</font> <font color="#993399">8.6080</font><font color="#990000">,</font> <font color="#993399">7.7218</font><font color="#FF0000">}}}</font><font color="#990000">,</font>
		<font color="#FF0000">{</font> <font color="#993399">60</font><font color="#990000">,</font> <font color="#993399">140</font><font color="#990000">,</font> <font color="#993399">0.1</font><font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">0.1</font><font color="#990000">,</font> <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">4.3512</font><font color="#990000">,</font> <font color="#993399">5.9998</font><font color="#990000">,</font> <font color="#993399">6.2395</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">6.9572</font><font color="#990000">,</font> <font color="#993399">7.4267</font><font color="#990000">,</font> <font color="#993399">5.6620</font><font color="#FF0000">}}}</font><font color="#990000">,</font>
		<font color="#FF0000">{</font> <font color="#993399">70</font><font color="#990000">,</font> <font color="#993399">130</font><font color="#990000">,</font> <font color="#993399">0.1</font><font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">0.1</font><font color="#990000">,</font> <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">4.3382</font><font color="#990000">,</font> <font color="#993399">5.2358</font><font color="#990000">,</font> <font color="#993399">4.3859</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">6.6058</font><font color="#990000">,</font> <font color="#993399">5.3761</font><font color="#990000">,</font> <font color="#993399">3.3446</font><font color="#FF0000">}}}</font><font color="#990000">,</font>
		<font color="#FF0000">{</font> <font color="#993399">80</font><font color="#990000">,</font> <font color="#993399">120</font><font color="#990000">,</font> <font color="#993399">0.1</font><font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">0.1</font><font color="#990000">,</font> <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">4.0428</font><font color="#990000">,</font> <font color="#993399">3.2872</font><font color="#990000">,</font> <font color="#993399">2.0048</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">5.0718</font><font color="#990000">,</font> <font color="#993399">2.6591</font><font color="#990000">,</font> <font color="#993399">1.1871</font><font color="#FF0000">}}}</font><font color="#990000">,</font>
		<font color="#FF0000">{</font> <font color="#993399">90</font><font color="#990000">,</font> <font color="#993399">110</font><font color="#990000">,</font> <font color="#993399">0.1</font><font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">0.1</font><font color="#990000">,</font> <font color="#FF0000">{</font> <font color="#FF0000">{</font><font color="#993399">1.9229</font><font color="#990000">,</font> <font color="#993399">0.6451</font><font color="#990000">,</font> <font color="#993399">0.1441</font><font color="#FF0000">}</font><font color="#990000">,</font> <font color="#FF0000">{</font><font color="#993399">1.7079</font><font color="#990000">,</font> <font color="#993399">0.3038</font><font color="#990000">,</font> <font color="#993399">0.0255</font><font color="#FF0000">}}}</font>

		<i><font color="#9A1900">/* Man, it was boring to write all those numbers :-(( */</font></i>
	<font color="#FF0000">}</font><font color="#990000">;</font>

	<font color="#008080">size_t</font> i<font color="#990000">,</font> nelem <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>values<font color="#990000">)</font> <font color="#990000">/</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>values<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]);</font>
	<b><font color="#000000">assert</font></b><font color="#990000">(</font>nelem <font color="#990000">==</font> <font color="#993399">15</font><font color="#990000">);</font>

	<b><font color="#0000FF">for</font></b><font color="#990000">(</font>i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> nelem<font color="#990000">;</font> i<font color="#990000">++)</font> <font color="#FF0000">{</font>
		<font color="#008080">size_t</font> iT<font color="#990000">;</font>
		<font color="#009900">double</font> T<font color="#990000">;</font>
		<b><font color="#0000FF">for</font></b><font color="#990000">(</font>iT <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">,</font> T <font color="#990000">=</font> <font color="#993399">0.25</font><font color="#990000">;</font> iT <font color="#990000">&lt;</font> <font color="#993399">2</font><font color="#990000">;</font> iT<font color="#990000">++,</font> T <font color="#990000">+=</font> <font color="#993399">0.25</font><font color="#990000">)</font> <font color="#FF0000">{</font>
			<font color="#008080">size_t</font> iv<font color="#990000">;</font>
			<font color="#009900">double</font> v<font color="#990000">;</font>
			<b><font color="#0000FF">for</font></b><font color="#990000">(</font>iv <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">,</font> v <font color="#990000">=</font> <font color="#993399">0.15</font><font color="#990000">;</font> iv <font color="#990000">&lt;</font> <font color="#993399">3</font><font color="#990000">;</font> iv<font color="#990000">++,</font> v <font color="#990000">+=</font> <font color="#993399">0.10</font><font color="#990000">)</font> <font color="#FF0000">{</font>
				<font color="#009900">double</font> res<font color="#990000">,</font> fasit <font color="#990000">=</font> values<font color="#990000">[</font>i<font color="#990000">].</font>fasit<font color="#990000">[</font>iT<font color="#990000">][</font>iv<font color="#990000">];</font>
				res <font color="#990000">=</font> <b><font color="#000000">DoubleBarrier</font></b><font color="#990000">(</font>typeflag<font color="#990000">,</font> S<font color="#990000">,</font> X<font color="#990000">,</font> values<font color="#990000">[</font>i<font color="#990000">].</font>L<font color="#990000">,</font> values<font color="#990000">[</font>i<font color="#990000">].</font>U<font color="#990000">,</font> T<font color="#990000">,</font> r<font color="#990000">,</font> b<font color="#990000">,</font> v<font color="#990000">,</font> values<font color="#990000">[</font>i<font color="#990000">].</font>d1<font color="#990000">,</font> values<font color="#990000">[</font>i<font color="#990000">].</font>d2<font color="#990000">);</font>
				<b><font color="#000000">assert_equal</font></b><font color="#990000">(</font>res<font color="#990000">,</font> fasit<font color="#990000">);</font>
			<font color="#FF0000">}</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>
<font color="#FF0000">}</font>


<font color="#009900">int</font> <b><font color="#000000">main</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#000000">check_DoubleBarrier</font></b><font color="#990000">();</font>
	<b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
<font color="#FF0000">}</font>

<b><font color="#000080">#endif</font></b>

</tt></pre>
